name: CI

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  test:
    name: Desktop Swift (${{ matrix.os }})
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        os: [macos-15, ubuntu-22.04, windows-2025]
    steps:
    - name: Checkout
      uses: actions/checkout@v4


    - name: Fetch Commander dependency
      shell: bash
      run: git clone --depth 1 https://github.com/steipete/Commander.git ../Commander

    - name: Select Xcode 16
      if: runner.os == 'macOS'
      run: sudo xcode-select -s /Applications/Xcode_16.1.app || sudo xcode-select -s /Applications/Xcode_16.0.app || sudo xcode-select -s /Applications/Xcode.app

    - name: Install Swift toolchain (macOS/Linux)
      if: runner.os != 'Windows'
      uses: SwiftyLab/setup-swift@v1
      with:
        swift-version: '6.2.1'

    - name: Install Swift toolchain (Windows)
      if: runner.os == 'Windows'
      uses: compnerd/gha-setup-swift@v0.3.0
      with:
        github-repo: swiftlang/swift
        release-tag-name: swift-6.2-RELEASE
        release-asset-name: swift-6.2-RELEASE-windows10.exe

    - name: Ensure Swift CLI available (Windows)
      if: runner.os == 'Windows'
      shell: pwsh
      run: |
        $swiftExe = Get-ChildItem -Path "C:\Users\runneradmin\AppData\Local\Programs\Swift" -Filter swift.exe -Recurse -ErrorAction SilentlyContinue | Select-Object -First 1
        if (-not $swiftExe) {
          $swiftExe = Get-ChildItem -Path "C:\Library\Developer" -Filter swift.exe -Recurse -ErrorAction SilentlyContinue | Select-Object -First 1
        }
        if (-not $swiftExe) {
          throw "Swift executable not found after installation."
        }
        $dir = Split-Path $swiftExe.FullName
        Add-Content -Path $env:GITHUB_PATH -Value $dir
        Write-Host "Added $dir to PATH"
        swift --version

    - name: Cache Swift Package Manager
      uses: actions/cache@v4
      with:
        path: |
          .build
          ~/.cache/org.swift.swiftpm
        key: ${{ runner.os }}-spm-${{ hashFiles('Package.resolved') }}
        restore-keys: |
          ${{ runner.os }}-spm-

    - name: Build
      run: swift build -c release --verbose

    - name: Run Tests (Unit Tests Only)
      run: |
        if [[ "${{ runner.os }}" == "Linux" ]]; then
          swift test --filter TachikomaTests --skip "AudioProvidersTests"
        else
          swift test --filter TachikomaTests
        fi
      env:
        TACHIKOMA_DISABLE_API_TESTS: "true"
        TACHIKOMA_TEST_MODE: "mock"
      continue-on-error: true

    - name: Run Package Tests (Full API Testing)
      run: swift test --verbose
      env:
        OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
        ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
        GROQ_API_KEY: ${{ secrets.GROQ_API_KEY }}
        MISTRAL_API_KEY: ${{ secrets.MISTRAL_API_KEY }}
        GOOGLE_API_KEY: ${{ secrets.GOOGLE_API_KEY }}
        X_AI_API_KEY: ${{ secrets.X_AI_API_KEY }}
        XAI_API_KEY: ${{ secrets.X_AI_API_KEY }}
      continue-on-error: true

  build-examples:
    name: Build Examples on ${{ matrix.os }}
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        os: [macos-15, ubuntu-22.04, windows-2025]
    steps:
    - name: Checkout
      uses: actions/checkout@v4

    - name: Fetch Commander dependency
      shell: bash
      run: git clone --depth 1 https://github.com/steipete/Commander.git ../Commander

    - name: Select Xcode 16
      if: runner.os == 'macOS'
      run: sudo xcode-select -s /Applications/Xcode_16.1.app || sudo xcode-select -s /Applications/Xcode_16.0.app || sudo xcode-select -s /Applications/Xcode.app

    - name: Install Swift toolchain (macOS/Linux)
      if: runner.os != 'Windows'
      uses: SwiftyLab/setup-swift@v1
      with:
        swift-version: '6.2.1'

    - name: Install Swift toolchain (Windows)
      if: runner.os == 'Windows'
      uses: compnerd/gha-setup-swift@v0.3.0
      with:
        github-repo: swiftlang/swift
        release-tag-name: swift-6.2-RELEASE
        release-asset-name: swift-6.2-RELEASE-windows10.exe

    - name: Ensure Swift CLI available (Windows)
      if: runner.os == 'Windows'
      shell: pwsh
      run: |
        $swiftExe = Get-ChildItem -Path "C:\Users\runneradmin\AppData\Local\Programs\Swift" -Filter swift.exe -Recurse -ErrorAction SilentlyContinue | Select-Object -First 1
        if (-not $swiftExe) {
          $swiftExe = Get-ChildItem -Path "C:\Library\Developer" -Filter swift.exe -Recurse -ErrorAction SilentlyContinue | Select-Object -First 1
        }
        if (-not $swiftExe) {
          throw "Swift executable not found after installation."
        }
        $dir = Split-Path $swiftExe.FullName
        Add-Content -Path $env:GITHUB_PATH -Value $dir
        Write-Host "Added $dir to PATH"
        swift --version

    - name: Build Examples
      run: |
        swift build --package-path . -c release
        find . -name "*.swift" -path "./Examples/*" -exec swiftc -typecheck {} \;
        find . -name "*_demo.swift" -exec swiftc -typecheck {} \;
        find . -name "*_examples.swift" -exec swiftc -typecheck {} \;

  apple-simulators:
    name: Apple Platforms (${{ matrix.platform }})
    runs-on: macos-15
    needs: test
    strategy:
      matrix:
        platform:
          - "iOS Simulator"
          - "tvOS Simulator"
          - "watchOS Simulator"
          - "visionOS Simulator"
    steps:
    - name: Checkout
      uses: actions/checkout@v4

    - name: Fetch Commander dependency
      shell: bash
      run: git clone --depth 1 https://github.com/steipete/Commander.git ../Commander
    - name: Select Xcode 16
      run: sudo xcode-select -s /Applications/Xcode_16.1.app || sudo xcode-select -s /Applications/Xcode_16.0.app || sudo xcode-select -s /Applications/Xcode.app
    - name: Build for ${{ matrix.platform }}
      run: |
        xcodebuild \
          -scheme Tachikoma-Package \
          -destination "generic/platform=${{ matrix.platform }}" \
          BUILD_LIBRARY_FOR_DISTRIBUTION=YES \
          build

  android:
    name: Android (aarch64)
    runs-on: ubuntu-22.04
    needs: test
    container:
      image: ghcr.io/swiftlang/swift:nightly-android-amd64
    steps:
    - name: Checkout
      uses: actions/checkout@v4

    - name: Fetch Commander dependency
      shell: bash
      run: git clone --depth 1 https://github.com/steipete/Commander.git ../Commander
    - name: Build Android artifacts
      env:
        SWIFT_ANDROID_TRIPLE: aarch64-unknown-linux-android24
      run: |
        swift build \
          --triple ${SWIFT_ANDROID_TRIPLE} \
          --build-path .build-android \
          --cxx-flags "-fPIC" \
          --swift-sdk android

  lint:
    name: SwiftLint
    runs-on: macos-15
    # SwiftLint only runs on macOS
    
    steps:
    - name: Checkout
      uses: actions/checkout@v4

    - name: Install SwiftLint
      run: brew install swiftlint

    - name: SwiftLint
      run: swiftlint --config .swiftlint.yml --strict
      continue-on-error: true # Don't fail CI on lint issues initially
