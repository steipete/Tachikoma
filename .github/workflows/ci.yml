name: CI

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  test:
    name: Desktop Swift (${{ matrix.os }})
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        os: [macos-15, ubuntu-22.04]
    steps:
    - name: Checkout
      uses: actions/checkout@v4


    - name: Fetch Commander dependency
      shell: bash
      run: git clone --depth 1 https://github.com/steipete/Commander.git ../Commander

    - name: Select Xcode (Swift 6.2)
      if: runner.os == 'macOS'
      run: sudo xcode-select -s /Applications/Xcode_26.1.app || sudo xcode-select -s /Applications/Xcode_26.0.app || sudo xcode-select -s /Applications/Xcode_16.4.app || sudo xcode-select -s /Applications/Xcode_16.3.app || sudo xcode-select -s /Applications/Xcode_16.2.app || sudo xcode-select -s /Applications/Xcode_16.1.app || sudo xcode-select -s /Applications/Xcode_16.0.app || sudo xcode-select -s /Applications/Xcode.app

    - name: Install Swift toolchain (macOS/Linux)
      if: runner.os != 'Windows'
      uses: SwiftyLab/setup-swift@v1
      with:
        swift-version: '6.2.1'

    - name: Cache Swift Package Manager
      uses: actions/cache@v4
      with:
        path: |
          .build
          ~/.cache/org.swift.swiftpm
        key: ${{ runner.os }}-spm-${{ hashFiles('Package.resolved') }}
        restore-keys: |
          ${{ runner.os }}-spm-

    - name: Build
      run: swift build -c release --verbose

    - name: Run Tests (Unit Tests Only)
      run: |
        if [[ "${{ runner.os }}" == "Linux" ]]; then
          swift test --filter TachikomaTests --skip "OpenAIAudioProviderTests" --skip "ProviderEndToEndTests"
        else
          swift test --filter TachikomaTests
        fi
      env:
        TACHIKOMA_DISABLE_API_TESTS: "true"
        TACHIKOMA_TEST_MODE: "mock"
      continue-on-error: true

    - name: Run Package Tests (Full API Testing)
      run: swift test --verbose
      env:
        OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
        ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
        GROQ_API_KEY: ${{ secrets.GROQ_API_KEY }}
        MISTRAL_API_KEY: ${{ secrets.MISTRAL_API_KEY }}
        GOOGLE_API_KEY: ${{ secrets.GOOGLE_API_KEY }}
        X_AI_API_KEY: ${{ secrets.X_AI_API_KEY }}
        XAI_API_KEY: ${{ secrets.X_AI_API_KEY }}
      continue-on-error: true

  build-examples:
    name: Build Examples on ${{ matrix.os }}
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        os: [macos-15]
    steps:
    - name: Checkout
      uses: actions/checkout@v4

    - name: Fetch Commander dependency
      shell: bash
      run: git clone --depth 1 https://github.com/steipete/Commander.git ../Commander

    - name: Select Xcode (Swift 6.2)
      if: runner.os == 'macOS'
      run: sudo xcode-select -s /Applications/Xcode_26.1.app || sudo xcode-select -s /Applications/Xcode_26.0.app || sudo xcode-select -s /Applications/Xcode_16.4.app || sudo xcode-select -s /Applications/Xcode_16.3.app || sudo xcode-select -s /Applications/Xcode_16.2.app || sudo xcode-select -s /Applications/Xcode_16.1.app || sudo xcode-select -s /Applications/Xcode_16.0.app || sudo xcode-select -s /Applications/Xcode.app

    - name: Install Swift toolchain (macOS/Linux)
      if: runner.os != 'Windows'
      uses: SwiftyLab/setup-swift@v1
      with:
        swift-version: '6.2.1'

    - name: Build Examples
      run: |
        RELEASE_BIN=$(swift build --package-path . -c release --show-bin-path)
        INCLUDE_FLAGS="-I $RELEASE_BIN"
        DEBUG_BIN="${RELEASE_BIN%/release}/debug"
        if [ -d "$DEBUG_BIN" ]; then
          INCLUDE_FLAGS="$INCLUDE_FLAGS -I $DEBUG_BIN"
        fi

        find . -name "*.swift" -path "./Examples/*" -exec swiftc $INCLUDE_FLAGS -typecheck {} \;
        find . -name "*_demo.swift" -exec swiftc $INCLUDE_FLAGS -typecheck {} \;
        find . -name "*_examples.swift" -exec swiftc $INCLUDE_FLAGS -typecheck {} \;

  apple-simulators:
    name: Apple Platforms (${{ matrix.platform }})
    runs-on: macos-15
    needs: test
    strategy:
      matrix:
        platform:
          - "iOS Simulator"
          - "tvOS Simulator"
          - "watchOS Simulator"
          - "visionOS Simulator"
    steps:
    - name: Checkout
      uses: actions/checkout@v4

    - name: Fetch Commander dependency
      shell: bash
      run: git clone --depth 1 https://github.com/steipete/Commander.git ../Commander
    - name: Select Xcode (Swift 6.2)
      run: sudo xcode-select -s /Applications/Xcode_26.1.app || sudo xcode-select -s /Applications/Xcode_26.0.app || sudo xcode-select -s /Applications/Xcode_16.4.app || sudo xcode-select -s /Applications/Xcode_16.3.app || sudo xcode-select -s /Applications/Xcode_16.2.app || sudo xcode-select -s /Applications/Xcode_16.1.app || sudo xcode-select -s /Applications/Xcode_16.0.app || sudo xcode-select -s /Applications/Xcode.app
    - name: Install Swift 6.2 toolchain
      uses: SwiftyLab/setup-swift@v1
      with:
        swift-version: '6.2.1'
    - name: Install simulator runtime for ${{ matrix.platform }}
      run: |
        case "${{ matrix.platform }}" in
          "iOS Simulator") RUNTIME="iOS" ;;
          "tvOS Simulator") RUNTIME="tvOS" ;;
          "watchOS Simulator") RUNTIME="watchOS" ;;
          "visionOS Simulator") RUNTIME="visionOS" ;;
          *) echo "Unknown platform: ${{ matrix.platform }}" && exit 1 ;;
        esac

        # Transient network flakiness is common for runtime downloads; retry a few times.
        for attempt in 1 2 3; do
          if sudo xcodebuild -downloadPlatform "$RUNTIME"; then
            exit 0
          fi
          echo "downloadPlatform $RUNTIME failed (attempt $attempt); retrying in 30s..."
          sleep 30
        done
        echo "Failed to download $RUNTIME simulator runtime after retries"
        exit 1
    - name: Build for ${{ matrix.platform }}
      env:
        TOOLCHAINS: swift
      run: |
        xcodebuild \
          -scheme Tachikoma-Package \
          -destination "generic/platform=${{ matrix.platform }}" \
          BUILD_LIBRARY_FOR_DISTRIBUTION=YES \
          build

  android:
    name: Android (aarch64)
    runs-on: ubuntu-22.04
    if: ${{ false }} # temporarily disabled: swift-android toolchain missing SwiftAndroid module; unblock CI
    needs: test
    steps:
    - name: Checkout
      uses: actions/checkout@v4

    - name: Fetch Commander dependency
      shell: bash
      run: git clone --depth 1 https://github.com/steipete/Commander.git ../Commander

    - name: Install Swift 6.2.1 toolchain
      uses: SwiftyLab/setup-swift@v1
      with:
        swift-version: '6.2.1'

    - name: Install Android Swift SDK (aarch64 API 24)
      env:
        ANDROID_SDK_URL: https://github.com/finagolfin/swift-android-sdk/releases/download/6.2/swift-6.2-RELEASE-android-24-0.1.artifactbundle.tar.gz
        ANDROID_SDK_CHECKSUM: c26ebfd4e32c0ca1beabcc45729b62042da57ee76d7d043f63f2235da90dc491
      run: |
        # Avoid older NDK environment leaking into the SDK installer
        unset ANDROID_NDK_HOME ANDROID_NDK_ROOT
        swift sdk install "$ANDROID_SDK_URL" --checksum "$ANDROID_SDK_CHECKSUM"
        swift sdk list

    - name: Build Android artifacts
      env:
        SWIFT_SDK: swift-6.2-RELEASE-android-24-0.1
        SWIFT_ANDROID_TRIPLE: aarch64-unknown-linux-android24
      run: |
        swift build \
          --swift-sdk "$SWIFT_SDK" \
          --triple ${SWIFT_ANDROID_TRIPLE} \
          --build-path .build-android \
          -Xcc -fPIC \
          -Xcxx -fPIC

  lint:
    name: SwiftLint
    runs-on: macos-15
    # SwiftLint only runs on macOS
    
    steps:
    - name: Checkout
      uses: actions/checkout@v4

    - name: Install SwiftLint
      run: brew install swiftlint

    - name: SwiftLint
      run: swiftlint --config .swiftlint.yml --strict
      continue-on-error: true # Don't fail CI on lint issues initially
