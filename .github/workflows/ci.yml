name: CI

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  test:
    name: Desktop Swift (${{ matrix.os }})
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        os: [macos-latest, ubuntu-22.04]
    steps:
    - name: Checkout
      uses: actions/checkout@v4


    - name: Fetch Commander dependency
      shell: bash
      run: git clone --depth 1 https://github.com/steipete/Commander.git ../Commander

    - name: Select Xcode 26.1
      if: runner.os == 'macOS'
      run: sudo xcode-select -s /Applications/Xcode_26.1.app || sudo xcode-select -s /Applications/Xcode_26.0.app || sudo xcode-select -s /Applications/Xcode.app

    - name: Install Swift toolchain (macOS/Linux)
      if: runner.os != 'Windows'
      uses: SwiftyLab/setup-swift@v1
      with:
        swift-version: '6.2.1'

    - name: Cache Swift Package Manager
      uses: actions/cache@v4
      with:
        path: |
          .build
          ~/.cache/org.swift.swiftpm
        key: ${{ runner.os }}-spm-${{ hashFiles('Package.resolved') }}
        restore-keys: |
          ${{ runner.os }}-spm-

    - name: Build
      run: swift build -c release --verbose

    - name: Run Tests (Unit Tests Only)
      run: |
        if [[ "${{ runner.os }}" == "Linux" ]]; then
          swift test --filter TachikomaTests --skip "OpenAIAudioProviderTests" --skip "ProviderEndToEndTests"
        else
          swift test --filter TachikomaTests
        fi
      env:
        TACHIKOMA_DISABLE_API_TESTS: "true"
        TACHIKOMA_TEST_MODE: "mock"
      continue-on-error: true

    - name: Run Package Tests (Full API Testing)
      run: swift test --verbose
      env:
        OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
        ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
        GROQ_API_KEY: ${{ secrets.GROQ_API_KEY }}
        MISTRAL_API_KEY: ${{ secrets.MISTRAL_API_KEY }}
        GOOGLE_API_KEY: ${{ secrets.GOOGLE_API_KEY }}
        X_AI_API_KEY: ${{ secrets.X_AI_API_KEY }}
        XAI_API_KEY: ${{ secrets.X_AI_API_KEY }}
      continue-on-error: true

  build-examples:
    name: Build Examples on ${{ matrix.os }}
    runs-on: ${{ matrix.os }}
    continue-on-error: true
    strategy:
      matrix:
        os: [macos-latest]
    steps:
    - name: Checkout
      uses: actions/checkout@v4

    - name: Fetch Commander dependency
      shell: bash
      run: git clone --depth 1 https://github.com/steipete/Commander.git ../Commander

    - name: Select Xcode 26.1
      if: runner.os == 'macOS'
      run: sudo xcode-select -s /Applications/Xcode_26.1.app || sudo xcode-select -s /Applications/Xcode_26.0.app || sudo xcode-select -s /Applications/Xcode.app

    - name: Install Swift toolchain (macOS/Linux)
      if: runner.os != 'Windows'
      uses: SwiftyLab/setup-swift@v1
      with:
        swift-version: '6.2.1'

    - name: Build Examples
      run: |
        # Build once in debug to ensure module artifacts land in the standard
        # .build/<triple>/debug location, which we can point swiftc at.
        DEBUG_BIN=$(swift build --package-path . --show-bin-path)
        INCLUDE_FLAGS="-I $DEBUG_BIN"

        # If a release build already exists, add it too so we pick up any
        # optimized module outputs from caches.
        RELEASE_BIN=${DEBUG_BIN%/debug}/release
        if [ -d "$RELEASE_BIN" ]; then
          INCLUDE_FLAGS="$INCLUDE_FLAGS -I $RELEASE_BIN"
        fi

        find Examples -name "*.swift" -exec swiftc $INCLUDE_FLAGS -typecheck {} \;
        find Examples -name "*_demo.swift" -exec swiftc $INCLUDE_FLAGS -typecheck {} \;
        find Examples -name "*_examples.swift" -exec swiftc $INCLUDE_FLAGS -typecheck {} \;

  apple-simulators:
    # Disabled for now: simulator SDK downloads are slow/flaky and not needed for core validation.
    if: false
    name: Apple Platforms (${{ matrix.platform }})
    runs-on: macos-latest
    needs: test
    strategy:
      matrix:
        platform: ["iOS Simulator"]
    steps:
      - run: echo "skipped"

  lint:
    name: SwiftLint
    runs-on: macos-latest
    # SwiftLint only runs on macOS
    
    steps:
    - name: Checkout
      uses: actions/checkout@v4

    - name: Install SwiftLint
      run: brew install swiftlint

    - name: SwiftLint
      run: swiftlint --config .swiftlint.yml --strict
      continue-on-error: true # Don't fail CI on lint issues initially
