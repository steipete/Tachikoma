name: CI

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  test:
    name: Desktop Swift (${{ matrix.os }})
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        os: [macos-latest, ubuntu-22.04, windows-latest]
    steps:
    - name: Checkout
      uses: actions/checkout@v4

    - name: Select Xcode 16
      if: runner.os == 'macOS'
      run: sudo xcode-select -s /Applications/Xcode_16.0.app || sudo xcode-select -s /Applications/Xcode.app

    - name: Install Swift via Swiftly (Linux)
      if: runner.os == 'Linux'
      run: |
        set -euxo pipefail
        curl -O https://download.swift.org/swiftly/linux/swiftly-1.1.0-$(uname -m).tar.gz
        tar -zxf swiftly-1.1.0-$(uname -m).tar.gz
        ./swiftly init --quiet-shell-followup
        . "${SWIFTLY_HOME_DIR:-$HOME/.local/share/swiftly}/env.sh"
        hash -r
        swift --version

    - name: Install Swift via WinGet (Windows)
      if: runner.os == 'Windows'
      shell: pwsh
      run: |
        $ErrorActionPreference = "Stop"
        winget install --id Microsoft.VisualStudio.2022.Community --exact --accept-package-agreements --accept-source-agreements --override "--add Microsoft.VisualStudio.Component.Windows11SDK.22000 --add Microsoft.VisualStudio.Component.VC.Tools.x86.x64 --add Microsoft.VisualStudio.Component.VC.Tools.ARM64 --quiet --wait --norestart"
        winget install --id Swift.Toolchain -e --accept-package-agreements --accept-source-agreements --silent
        $swiftRoot = "$env:LOCALAPPDATA\Programs\Swift\bin"
        if (Test-Path $swiftRoot) {
          "$swiftRoot" | Out-File -FilePath $env:GITHUB_PATH -Encoding utf8 -Append
        }
        swift --version

    - name: Cache Swift Package Manager
      uses: actions/cache@v4
      with:
        path: |
          .build
          ~/.cache/org.swift.swiftpm
        key: ${{ runner.os }}-spm-${{ hashFiles('Package.resolved') }}
        restore-keys: |
          ${{ runner.os }}-spm-

    - name: Build
      run: swift build -c release --verbose

    - name: Run Tests (Unit Tests Only)
      run: |
        if [[ "${{ runner.os }}" == "Linux" ]]; then
          swift test --filter TachikomaTests --skip "AudioProvidersTests"
        else
          swift test --filter TachikomaTests
        fi
      env:
        TACHIKOMA_DISABLE_API_TESTS: "true"
        TACHIKOMA_TEST_MODE: "mock"
      continue-on-error: true

    - name: Run Package Tests (Full API Testing)
      run: swift test --verbose
      env:
        OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
        ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
        GROQ_API_KEY: ${{ secrets.GROQ_API_KEY }}
        MISTRAL_API_KEY: ${{ secrets.MISTRAL_API_KEY }}
        GOOGLE_API_KEY: ${{ secrets.GOOGLE_API_KEY }}
        X_AI_API_KEY: ${{ secrets.X_AI_API_KEY }}
        XAI_API_KEY: ${{ secrets.X_AI_API_KEY }}
      continue-on-error: true

  build-examples:
    name: Build Examples on ${{ matrix.os }}
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        os: [macos-latest, ubuntu-22.04, windows-latest]
    steps:
    - name: Checkout
      uses: actions/checkout@v4

    - name: Select Xcode 16
      if: runner.os == 'macOS'
      run: sudo xcode-select -s /Applications/Xcode_16.0.app || sudo xcode-select -s /Applications/Xcode.app

    - name: Install Swift via Swiftly (Linux)
      if: runner.os == 'Linux'
      run: |
        set -euxo pipefail
        curl -O https://download.swift.org/swiftly/linux/swiftly-1.1.0-$(uname -m).tar.gz
        tar -zxf swiftly-1.1.0-$(uname -m).tar.gz
        ./swiftly init --quiet-shell-followup
        . "${SWIFTLY_HOME_DIR:-$HOME/.local/share/swiftly}/env.sh"
        hash -r
        swift --version

    - name: Install Swift via WinGet (Windows)
      if: runner.os == 'Windows'
      shell: pwsh
      run: |
        $ErrorActionPreference = "Stop"
        winget install --id Microsoft.VisualStudio.2022.Community --exact --accept-package-agreements --accept-source-agreements --override "--add Microsoft.VisualStudio.Component.Windows11SDK.22000 --add Microsoft.VisualStudio.Component.VC.Tools.x86.x64 --add Microsoft.VisualStudio.Component.VC.Tools.ARM64 --quiet --wait --norestart"
        winget install --id Swift.Toolchain -e --accept-package-agreements --accept-source-agreements --silent
        $swiftRoot = "$env:LOCALAPPDATA\Programs\Swift\bin"
        if (Test-Path $swiftRoot) {
          "$swiftRoot" | Out-File -FilePath $env:GITHUB_PATH -Encoding utf8 -Append
        }
        swift --version

    - name: Build Examples
      run: |
        swift build --package-path . -c release
        find . -name "*.swift" -path "./Examples/*" -exec swift -typecheck {} \;
        find . -name "*_demo.swift" -exec swift -typecheck {} \;
        find . -name "*_examples.swift" -exec swift -typecheck {} \;

  apple-simulators:
    name: Apple Platforms (${{ matrix.platform }})
    runs-on: macos-latest
    needs: test
    strategy:
      matrix:
        platform:
          - "iOS Simulator"
          - "tvOS Simulator"
          - "watchOS Simulator"
          - "visionOS Simulator"
    steps:
    - name: Checkout
      uses: actions/checkout@v4
    - name: Select Xcode 16
      run: sudo xcode-select -s /Applications/Xcode_16.0.app || sudo xcode-select -s /Applications/Xcode.app
    - name: Build for ${{ matrix.platform }}
      run: |
        xcodebuild \
          -scheme Tachikoma-Package \
          -destination "generic/platform=${{ matrix.platform }}" \
          BUILD_LIBRARY_FOR_DISTRIBUTION=YES \
          build

  android:
    name: Android (aarch64)
    runs-on: ubuntu-22.04
    needs: test
    container:
      image: ghcr.io/swiftlang/swift:nightly-android-amd64
    steps:
    - name: Checkout
      uses: actions/checkout@v4
    - name: Build Android artifacts
      env:
        SWIFT_ANDROID_TRIPLE: aarch64-unknown-linux-android24
      run: |
        swift build \
          --triple ${SWIFT_ANDROID_TRIPLE} \
          --build-path .build-android \
          --cxx-flags "-fPIC" \
          --swift-sdk android

  lint:
    name: SwiftLint
    runs-on: macos-14
    # SwiftLint only runs on macOS
    
    steps:
    - name: Checkout
      uses: actions/checkout@v4
      
    - name: SwiftLint
      uses: norio-nomura/action-swiftlint@3.2.1
      continue-on-error: true # Don't fail CI on lint issues initially
