name: Lint

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  swiftlint:
    name: SwiftLint
    runs-on: macos-latest
    steps:
    - name: Checkout
      uses: actions/checkout@v4

    - name: Fetch Commander dependency
      shell: bash
      run: git clone --depth 1 https://github.com/steipete/Commander.git ../Commander

    - name: Setup Xcode 26.1
      uses: maxim-lobanov/setup-xcode@v1
      with:
        xcode-version: '26.1'

    - name: Cache SwiftLint
      uses: actions/cache@v4
      with:
        path: |
          ~/.mint
          /usr/local/bin/swiftlint
        key: ${{ runner.os }}-swiftlint-${{ hashFiles('.swiftlint.yml') }}
        restore-keys: |
          ${{ runner.os }}-swiftlint-

    - name: Install SwiftLint
      run: |
        if ! command -v swiftlint &> /dev/null; then
          brew install swiftlint
        fi

    - name: Verify SwiftLint Version
      run: |
        swiftlint version
        echo "SwiftLint configuration:"
        cat .swiftlint.yml || echo "No .swiftlint.yml found"

    - name: Run SwiftLint
      run: |
        swiftlint lint --reporter github-actions-logging --strict --quiet
        
    - name: Run SwiftLint (Autocorrect Check)
      run: |
        # Apply autocorrect and fail if it would change files.
        swiftlint lint --fix --quiet
        if ! git diff --quiet; then
          echo "::error::SwiftLint autocorrect produced changes. Run 'swiftlint lint --fix' locally and commit the results."
          git status -sb
          git --no-pager diff
          exit 1
        fi

  swiftformat:
    name: SwiftFormat
    runs-on: macos-latest
    steps:
    - name: Checkout
      uses: actions/checkout@v4

    - name: Fetch Commander dependency
      shell: bash
      run: git clone --depth 1 https://github.com/steipete/Commander.git ../Commander

    - name: Setup Xcode 26.1
      uses: maxim-lobanov/setup-xcode@v1
      with:
        xcode-version: '26.1'

    - name: Cache SwiftFormat
      uses: actions/cache@v4
      with:
        path: |
          ~/.mint
          /usr/local/bin/swiftformat
        key: ${{ runner.os }}-swiftformat-${{ hashFiles('.swiftformat') }}
        restore-keys: |
          ${{ runner.os }}-swiftformat-

    - name: Install SwiftFormat
      run: |
        if ! command -v swiftformat &> /dev/null; then
          brew install swiftformat
        fi

    - name: Verify SwiftFormat Version
      run: |
        swiftformat --version
        echo "SwiftFormat configuration:"
        cat .swiftformat || echo "No .swiftformat found"

    - name: Check SwiftFormat
      run: |
        swiftformat --lint .

  swift6-compatibility:
    name: Swift 6 Compatibility Check
    runs-on: macos-latest
    steps:
    - name: Checkout
      uses: actions/checkout@v4

    - name: Fetch Commander dependency
      shell: bash
      run: git clone --depth 1 https://github.com/steipete/Commander.git ../Commander

    - name: Setup Xcode 26.1
      uses: maxim-lobanov/setup-xcode@v1
      with:
        xcode-version: '26.1'

    - name: Check Swift 6 Language Mode
      run: |
        # Verify Swift 6 language mode is enabled (either via swiftLanguageModes or swiftLanguageVersion)
        cd ${GITHUB_WORKSPACE}
        SWIFT_DUMP="$(swift package dump-package 2>/dev/null)"
        if jq -e '.swiftLanguageModes[] | select(. == "6")' <<< "$SWIFT_DUMP" >/dev/null 2>&1; then
          echo "Swift 6 language mode detected via dump-package"
        elif jq -e '.swiftLanguageVersion | select(. == "6")' <<< "$SWIFT_DUMP" >/dev/null 2>&1; then
          echo "Swift 6 language version directive detected"
        else
          echo "::warning::Swift 6 language mode not found in Package.swift (non-blocking)"
        fi

    - name: Build with Swift 6 Language Mode
      run: |
        # Build with Swift 6 language mode but relaxed concurrency for dependencies
        swift build \
          -Xswiftc -swift-version \
          -Xswiftc 6 \
          -Xswiftc -warn-concurrency

    - name: Check for Swift 6 Migration Issues (Non-Strict)
      run: |
        # Build with Swift 6 but allow dependency compatibility issues
        # Note: swift-log dependency has known strict concurrency issues
        swift build \
          -Xswiftc -swift-version \
          -Xswiftc 6 \
          -Xswiftc -warn-concurrency \
          || echo "Swift 6 strict mode has dependency compatibility issues - this is expected"

  package-validation:
    name: Package Validation
    runs-on: macos-15
    steps:
    - name: Checkout
      uses: actions/checkout@v4

    - name: Fetch Commander dependency
      shell: bash
      run: git clone --depth 1 https://github.com/steipete/Commander.git ../Commander

    - name: Setup Xcode
      uses: maxim-lobanov/setup-xcode@v1
      with:
        xcode-version: latest-stable

    - name: Validate Swift Package Structure
      run: |
        # Check package structure
        swift package describe --type json | jq '.'
        
        # Validate dependencies
        swift package show-dependencies --format json | jq '.'

    - name: Check Documentation
      run: |
        # Verify documentation coverage when the Swift toolchain supports doc generation
        if swift package --help | grep -q "generate-documentation"; then
          swift package generate-documentation --warnings-as-errors --analyze
        else
          echo "::warning::Swift toolchain does not support 'swift package generate-documentation'; skipping doc validation."
        fi
